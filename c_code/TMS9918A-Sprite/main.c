#include <stdint.h>
#include <stdio.h>
#include "simplePrint.h"
#include "mc68681.h"
#include "tms9918a.h"

const uint8_t vsyncDiv = 6;		// number of interrupts per animation frame
const uint8_t spriteCount = 8;	// number of frames in animation

uint8_t vsyncCount = 0;
uint8_t currSprite = 0;
uint8_t xDelta = 1;
uint8_t yDelta = 1;

// planet sprites from TI VDP Programmer's guide
const uint8_t spritePatterns[] = {
        // Sprite world0 pattern 1
        0x007, 0x01C, 0x038, 0x070, 0x078, 0x05C, 0x00E, 0x00F,
        0x00F, 0x01F, 0x07F, 0x063, 0x073, 0x03D, 0x01F, 0x007,
        0x0E0, 0x0F8, 0x07C, 0x066, 0x0F2, 0x0BE, 0x0DC, 0x0FC,
        0x0F8, 0x0A0, 0x0C0, 0x0C0, 0x0E2, 0x0F4, 0x0F8, 0x0E0,

        // Sprite world0 pattern 2
        0x000, 0x003, 0x007, 0x00F, 0x007, 0x0A3, 0x0F1, 0x0F0,
        0x0F0, 0x0E0, 0x080, 0x01C, 0x00C, 0x002, 0x000, 0x000,
        0x000, 0x000, 0x080, 0x098, 0x00C, 0x041, 0x023, 0x003,
        0x007, 0x05F, 0x03F, 0x03E, 0x01C, 0x008, 0x000, 0x000,

        // Sprite world1 pattern 1
        0x003, 0x01F, 0x03E, 0x07C, 0x07E, 0x097, 0x003, 0x003,
        0x003, 0x007, 0x01F, 0x078, 0x07C, 0x03F, 0x01F, 0x007,
        0x0E0, 0x038, 0x01C, 0x018, 0x03C, 0x02F, 0x0B7, 0x0FF,
        0x0FE, 0x0E8, 0x0F0, 0x0F0, 0x0F8, 0x07C, 0x0F8, 0x0E0,

        // Sprite world1 pattern 2
        0x000, 0x000, 0x001, 0x003, 0x001, 0x068, 0x0FC, 0x0FC,
        0x0FC, 0x0F8, 0x0E0, 0x007, 0x003, 0x000, 0x000, 0x000,
        0x000, 0x0C0, 0x0E0, 0x0E6, 0x0C2, 0x0D0, 0x048, 0x000,
        0x001, 0x017, 0x00F, 0x00E, 0x006, 0x080, 0x000, 0x000,

        // Sprite world2 pattern 1
        0x007, 0x01F, 0x03F, 0x07F, 0x03F, 0x0E5, 0x0C0, 0x0C0,
        0x080, 0x001, 0x007, 0x01E, 0x03F, 0x03F, 0x01F, 0x007,
        0x0E0, 0x0C8, 0x084, 0x006, 0x08E, 0x0CB, 0x0ED, 0x0FF,
        0x0FF, 0x0FA, 0x0FC, 0x03C, 0x03E, 0x0DC, 0x0F8, 0x0E0,

        // Sprite world2 pattern 2
        0x000, 0x000, 0x000, 0x000, 0x040, 0x01A, 0x03F, 0x03F,
        0x07F, 0x0FE, 0x0F8, 0x061, 0x040, 0x000, 0x000, 0x000,
        0x000, 0x030, 0x078, 0x0F8, 0x070, 0x034, 0x012, 0x000,
        0x000, 0x005, 0x003, 0x0C2, 0x0C0, 0x020, 0x000, 0x000,

        // Sprite world3 pattern 1
        0x007, 0x01F, 0x03F, 0x01F, 0x04F, 0x0F9, 0x070, 0x0F0,
        0x0E0, 0x080, 0x001, 0x007, 0x00F, 0x01F, 0x01F, 0x007,
        0x0E0, 0x0F0, 0x0E0, 0x0C2, 0x0E2, 0x072, 0x03B, 0x03F,
        0x03F, 0x07E, 0x0FF, 0x08E, 0x0CE, 0x0F4, 0x0F8, 0x0E0,

        // Sprite world3 pattern 2
        0x000, 0x000, 0x000, 0x060, 0x030, 0x006, 0x08F, 0x00F,
        0x01F, 0x07F, 0x0FE, 0x078, 0x070, 0x020, 0x000, 0x000,
        0x000, 0x008, 0x01C, 0x03C, 0x01C, 0x08D, 0x0C4, 0x0C0,
        0x0C0, 0x081, 0x000, 0x070, 0x030, 0x008, 0x000, 0x000,

        // Sprite world4 pattern 1
        0x007, 0x01F, 0x03F, 0x067, 0x073, 0x0BE, 0x0DC, 0x0FC,
        0x0F8, 0x0A0, 0x0C0, 0x041, 0x063, 0x037, 0x01F, 0x007,
        0x0E0, 0x0F8, 0x0F8, 0x0F0, 0x0F8, 0x05C, 0x00E, 0x00F,
        0x00F, 0x01F, 0x07F, 0x0E2, 0x0F2, 0x0FC, 0x0F8, 0x0E0,

        // Sprite world4 pattern 2
        0x000, 0x000, 0x000, 0x018, 0x00C, 0x041, 0x023, 0x003,
        0x007, 0x05F, 0x03F, 0x03E, 0x01C, 0x008, 0x000, 0x000,
        0x000, 0x000, 0x004, 0x00E, 0x006, 0x0A3, 0x0F1, 0x0F0,
        0x0F0, 0x0E0, 0x080, 0x01C, 0x00C, 0x000, 0x000, 0x000,

        // Sprite world5 pattern 1
        0x007, 0x01F, 0x01F, 0x019, 0x03C, 0x02F, 0x0B7, 0x0FF,
        0x0FE, 0x0E8, 0x0F0, 0x070, 0x078, 0x03D, 0x01F, 0x007,
        0x0E0, 0x0F8, 0x0FC, 0x0FC, 0x0FE, 0x097, 0x003, 0x003,
        0x003, 0x007, 0x01F, 0x078, 0x0FC, 0x0FC, 0x0F8, 0x0E0,

        // Sprite world5 pattern 2
        0x000, 0x000, 0x020, 0x066, 0x043, 0x0D0, 0x048, 0x000,
        0x001, 0x017, 0x00F, 0x00F, 0x007, 0x002, 0x000, 0x000,
        0x000, 0x000, 0x000, 0x002, 0x000, 0x068, 0x0FC, 0x0FC,
        0x0FC, 0x0F8, 0x0E0, 0x086, 0x002, 0x000, 0x000, 0x000,

        // Sprite world6 pattern 1
        0x007, 0x00F, 0x007, 0x006, 0x00F, 0x0CB, 0x0ED, 0x0FF,
        0x0FF, 0x0FA, 0x0FC, 0x03C, 0x03E, 0x01F, 0x01F, 0x007,
        0x0E0, 0x0F8, 0x0FC, 0x07E, 0x03E, 0x0E5, 0x0C0, 0x0C0,
        0x080, 0x001, 0x007, 0x01E, 0x03E, 0x07C, 0x0F8, 0x0E0,

        // Sprite world6 pattern 2
        0x000, 0x010, 0x038, 0x079, 0x070, 0x034, 0x012, 0x000,
        0x000, 0x005, 0x003, 0x043, 0x041, 0x020, 0x000, 0x000,
        0x000, 0x000, 0x000, 0x080, 0x0C0, 0x01A, 0x03F, 0x03F,
        0x07F, 0x0FE, 0x0F8, 0x0E0, 0x0C0, 0x080, 0x000, 0x000,

        // Sprite world7 pattern 1
        0x007, 0x013, 0x021, 0x041, 0x063, 0x072, 0x03B, 0x03F,
        0x03F, 0x07E, 0x0FF, 0x00F, 0x04F, 0x037, 0x01F, 0x007,
        0x0E0, 0x0F8, 0x0FC, 0x09E, 0x0CE, 0x0F9, 0x070, 0x0F0,
        0x0E0, 0x080, 0x001, 0x006, 0x08E, 0x0DC, 0x0F8, 0x0E0,

        // Sprite world7 pattern 2
        0x000, 0x00C, 0x01E, 0x03E, 0x01C, 0x08D, 0x0C4, 0x0C0,
        0x0C0, 0x081, 0x000, 0x070, 0x030, 0x008, 0x000, 0x000,
        0x000, 0x000, 0x000, 0x060, 0x030, 0x006, 0x08F, 0x00F,
        0x01F, 0x07F, 0x0FE, 0x0F8, 0x070, 0x020, 0x000, 0x000
};

// simple zero based list of sprite attribute names
enum spriteDefs { sprite1Y, sprite1X, sprite1Name, sprite1Colour,
                  sprite2Y, sprite2X, sprite2Name, sprite2Colour
				};
uint8_t spriteAttributes[] = {
		// sprite1Y, sprite1X, sprite1Name, sprite1Colour
		88, 0, 0, TmsDarkBlue,

		// sprite2Y, sprite2X, sprite2Name, sprite2Colour
		88, 0, 4, TmsLightGreen
};
		
int main(void)
{
uint8_t result;

	putStr("Simple demo of the TMSEMU (TMS9918A) video board.\n");
	putStr("Sprite demo based on the Z80 code by JB Langston.\n");

	vsyncCount = vsyncDiv;
	currSprite = 0;
	
	result = tmsProbe();
	
	if (result !=0 ) {
		tmsBitmap();

		tmsSpriteConfig( TmsSprite32 );
		tmsLoadSprites( spritePatterns, sizeof( spritePatterns ) );

		while( 1 ) {
			// wait for vsync
			while (( tmsRegIn() & 0x80 ) == 0 ) {
			};
		
			// update the X coordinate
			spriteAttributes[ sprite1X ] = spriteAttributes[ sprite1X ] + xDelta;
			spriteAttributes[ sprite2X ] = spriteAttributes[ sprite2X ] + xDelta;
			
			// change the X direction if the sprite reaches the edge
			if ( spriteAttributes[ sprite1X ] >= 240 ) xDelta = -xDelta;
			if ( spriteAttributes[ sprite1X ] <= 0 ) xDelta = -xDelta;

			// update the Y coordinate
			spriteAttributes[ sprite1Y ] = spriteAttributes[ sprite1Y ] + yDelta;
			spriteAttributes[ sprite2Y ] = spriteAttributes[ sprite2Y ] + yDelta;
			
			// change the Y direction if the sprite reaches the edge
			if ( spriteAttributes[ sprite1Y ] >= 176 ) yDelta = -yDelta;
			if ( spriteAttributes[ sprite1Y ] <= 0 ) yDelta = -yDelta;
			
			tmsUpdateSprites( spriteAttributes, sizeof( spriteAttributes ) );
		}
	}
	else
	{
		putStr("\nCound not detect TMSEMU board at address 0x");
		putByte( TMS9918A_ADDR );
		putStr("\n\n");
	}
    return 0;
}
